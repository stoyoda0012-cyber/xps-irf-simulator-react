# XPS IRF シミュレータ & 分解能エクスプローラ (React版)

リアルタイムXPS（X線光電子分光）IRFシミュレータ。インタラクティブなパラメータ制御が可能です。

## 概要

これは[Streamlit版 XPS IRF Simulator](https://github.com/stoyoda0012-cyber/XPSTwin_streamlit)のReact版再実装です。スライダー操作時のリアルタイムな応答性を重視して設計されています。

### Streamlit版からの主な改善点

| 機能 | Streamlit版 | React版 |
|------|-------------|---------|
| **応答性** | スライダーリリース時に更新 | ドラッグ中にリアルタイム更新 |
| **描画方式** | SVGベース (Matplotlib) | Canvasベース (uPlot) |
| **性能** | 更新あたり約500ms | 更新あたり約16ms (60 FPS) |
| **分解能モデル** | 検出器のみ | 光源＋検出器（合成） |
| **パラメータ名** | 汎用的 (Spot Size X/Y) | 物理的に正確 (光源分解能, 検出器分解能) |

## 特徴

- **リアルタイムシミュレーション**: パラメータ調整時に即座に視覚的フィードバック
- **Canvasベース描画**: 滑らかな60 FPS更新のためのuPlotチャート
- **合成分解能モデル**: 光源と検出器分解能の正しい畳み込み
- **バイリンガルUI**: 英語/日本語切り替え
- **コンパクト設計**: スクロールなしで全コントロールと可視化を表示

## クイックスタート

```bash
# クローンとインストール
cd xps-irf-simulator-react
npm install

# 開発モード
npm run dev

# プロダクションビルド
npm run build
npm run preview
```

## 物理モデル

### 装置応答関数 (IRF)

総IRFは光源と検出器の寄与の畳み込みです：

```
IRF_total = IRF_source ⊗ IRF_detector
```

ガウシアンブロードニングの場合、合成分解能は：

```
σ_combined = √(σ_source² + σ_detector²)
```

### パラメータ

#### X線源

| パラメータ | 記号 | 説明 | 単位 |
|-----------|------|------|------|
| 光源分解能 | σ_src | X線源の固有エネルギー分解能 | meV |
| スポット幅 | σ_Y | 試料上のX線スポットの空間的広がり | mm |
| エネルギー歪度 | γ_E | 光源エネルギー分布の非対称性 | - |
| 空間歪度 | γ_Y | スポット空間分布の非対称性 | - |
| エネルギー勾配 | α | スポット内のエネルギー変化 (dE/dy) | eV/mm |

#### 2D検出器

| パラメータ | 記号 | 説明 | 単位 |
|-----------|------|------|------|
| スマイル曲率 | κ | アナライザー収差による放物線歪み | - |
| 検出器傾き | θ | 検出器取り付け角度のズレ | ° |
| 検出器分解能 | σ_det | 2D検出器の固有分解能 | meV |

#### 測定条件

| パラメータ | 説明 | 単位 |
|-----------|------|------|
| 温度 | フェルミ・ディラック分布の試料温度 | K |
| ポアソンノイズ | 光子計数統計ノイズ（対数スケール） | - |
| ガウシアンノイズ | 検出器読み出しノイズ | % |

### シミュレーションパイプライン

1. **フェルミ・ディラック分布**: 指定温度での理想的なステップ関数を生成
2. **2D発光**: X線スポットの空間分布を通してスペクトルを投影
3. **検出器歪み**: スマイル曲率と傾きの変換を適用
4. **分解能畳み込み**: 光源と検出器のガウシアンカーネルで畳み込み
5. **1D投影**: 空間軸に沿って積算し、観測スペクトルを取得
6. **ノイズ付加**: ポアソンおよびガウシアンノイズを適用

## プロジェクト構造

```
xps-irf-simulator-react/
├── src/
│   ├── App.tsx                  # メインアプリケーションコンポーネント
│   ├── App.css                  # グローバルスタイル
│   ├── components/
│   │   ├── Slider.tsx           # パラメータスライダーコンポーネント
│   │   ├── HeatMap.tsx          # Canvasベース2Dヒートマップ
│   │   └── SpectrumChartCanvas.tsx  # uPlotベース1Dチャート
│   ├── lib/
│   │   ├── simulator.ts         # メインシミュレーションエンジン
│   │   └── physics.ts           # 物理計算
│   └── i18n/
│       └── translations.ts      # 英語/日本語翻訳
├── package.json
├── vite.config.ts
└── README.md
```

## 技術詳細

### シミュレーションエンジン (`src/lib/simulator.ts`)

- **拡張グリッド計算**: 端のアーティファクトを避けるため、内部的には広い範囲（-150〜+150 meV）を使用
- **表示範囲**: -100〜+100 meV
- **グリッド点数**: 500（エネルギー）× 200（空間）
- **ダウンサンプリング**: 最適なパフォーマンスのためチャートは200点を表示

### 物理計算 (`src/lib/physics.ts`)

- **フェルミ・ディラック**: `f(E) = 1 / (1 + exp(E / kT))`
- **歪みガウシアン**: 誤差関数を使用した非対称ガウシアン
- **畳み込み**: FFTベースのガウシアン畳み込み
- **2D楕円ガウシアン**: スポットプロファイル可視化用

### パフォーマンス最適化

1. **Canvas描画**: SVGベースのRechartsの代わりにuPlotを使用
2. **メモ化**: シミュレーション結果に`useMemo`を使用
3. **効率的な更新**: 変更されたコンポーネントのみを再描画
4. **データダウンサンプリング**: スムーズな操作のため200点表示

## 移行メモ（Streamlit版から）

### パラメータ名の変更

| Streamlit版 | React版 | 理由 |
|-------------|---------|------|
| Spot Size X (σ_x) | 光源分解能 (σ) | 空間ではなくエネルギー分解能であることを明確化 |
| Spot Size Y (σ_y) | スポット幅 | X線スポットの物理的な空間的広がり |
| Intrinsic Resolution (σ) | 検出器分解能 (σ) | 検出器固有であることを明示 |
| Spot Skew X (γ_x) | エネルギー歪度 (γ) | エネルギー方向の歪み |
| Spot Skew Y (γ_y) | 空間歪度 (γ) | 空間方向の歪み |

### 物理モデルの変更

1. **スペクトル計算における光源分解能**: 光源分解能をスペクトル計算に正しく畳み込むようになりました（以前は2Dスポットプロファイル表示にのみ影響）
2. **合成分解能表示**: σ_combined = √(σ_src² + σ_det²) のリアルタイム計算を表示

## 依存関係

- React 19
- TypeScript 5
- Vite 7
- uPlot（Canvasベースチャート）

## 作者

豊田聡

## ライセンス

MIT License

## 謝辞

- オリジナルStreamlit実装: [XPSTwin_streamlit](https://github.com/stoyoda0012-cyber/XPSTwin_streamlit)
- Claude Code (Anthropic) で構築
